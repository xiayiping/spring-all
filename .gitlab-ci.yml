
stages:
  - preMergeCheck
  - test
  - mergeTest
  - deploy
  - finish

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH

job-preMergeCheck:
  stage: preMergeCheck
  image: maven:3.8.3-openjdk-17
  only:
    - merge_requests
  script:
    - echo "pass jira number check  ";

# merge should test
job-test:
  stage: test
  #  tags:
  #    - maven3.8-java17
  image: maven:3.8.3-openjdk-17
  script:
    - echo "Hello, this is test."
    - mvn compile test -Dspring.profiles.active=test

# merge should test
job-mergeTest:
  stage: mergeTest
  #  tags:
  #    - maven3.8-java17
  image: maven:3.8.3-openjdk-17
  only:
    - merge_requests
  script:
    - echo "Hello, this is test."
    - mvn compile test -Dspring.profiles.active=test

# approve merge should deploy
job-deploy:
  stage: deploy
#  tags:
#    - maven3.8-java17
  #  image: maven:3.8.3-openjdk-17
  script:
    - echo "Hello, this is deploy. 1 $CI_MERGE_REQUEST_TARGET_BRANCH_SHA"
    - echo "Hello, this is deploy. 1 $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
    - printenv


job-finish:
  stage: finish
#  tags:
#    - maven3.8-java17
  #  image: maven:3.8.3-openjdk-17
  script:
    - echo "Hello, this is finish. add sth  22"
    - printenv